'use strict';"use strict";
var lang_1 = require('angular2/src/facade/lang');
var compile_metadata_1 = require('../compile_metadata');
var identifiers_1 = require('../identifiers');
var o = require('../output/output_ast');
var parse_util_1 = require('../parse_util');
var provider_parser_1 = require('../provider_parser');
var constants_1 = require('./constants');
var util_1 = require('./util');
var mainModuleProp = o.THIS_EXPR.prop('mainModule');
var parentInjectorProp = o.THIS_EXPR.prop('parent');
var InjectorCompileResult = (function () {
    function InjectorCompileResult(statements, injectorFactoryVar) {
        this.statements = statements;
        this.injectorFactoryVar = injectorFactoryVar;
    }
    return InjectorCompileResult;
}());
exports.InjectorCompileResult = InjectorCompileResult;
var InjectorCompiler = (function () {
    function InjectorCompiler() {
    }
    InjectorCompiler.prototype.compileInjector = function (injectorModuleMeta) {
        var builder = new _InjectorBuilder(injectorModuleMeta);
        var sourceFileName = lang_1.isPresent(injectorModuleMeta.moduleUrl) ?
            "in InjectorModule " + injectorModuleMeta.name + " in " + injectorModuleMeta.moduleUrl :
            "in InjectorModule " + injectorModuleMeta.name;
        var sourceFile = new parse_util_1.ParseSourceFile('', sourceFileName);
        var providerParser = new provider_parser_1.AppProviderParser(new parse_util_1.ParseSourceSpan(new parse_util_1.ParseLocation(sourceFile, null, null, null), new parse_util_1.ParseLocation(sourceFile, null, null, null)), injectorModuleMeta.providers);
        providerParser.parse().forEach(function (provider) { return builder.addProvider(provider); });
        var injectorClass = builder.build();
        var injectorFactoryVar = injectorClass.name + "Factory";
        var injectorFactoryFnVar = injectorClass.name + "FactoryClosure";
        var injectorFactoryFn = o.fn(injectorClass.constructorMethod.params, [
            new o.ReturnStatement(o.variable(injectorClass.name)
                .instantiate(injectorClass.constructorMethod.params.map(function (param) { return o.variable(param.name); })))
        ], o.importType(identifiers_1.Identifiers.Injector))
            .toDeclStmt(injectorFactoryFnVar);
        var injectorFactoryStmt = o.variable(injectorFactoryVar)
            .set(o.importExpr(identifiers_1.Identifiers.InjectorFactory, [o.importType(injectorModuleMeta)])
            .instantiate([o.variable(injectorFactoryFnVar)], o.importType(identifiers_1.Identifiers.InjectorFactory, [o.importType(injectorModuleMeta)], [o.TypeModifier.Const])))
            .toDeclStmt(null, [o.StmtModifier.Final]);
        return new InjectorCompileResult([injectorClass, injectorFactoryFn, injectorFactoryStmt], injectorFactoryVar);
    };
    return InjectorCompiler;
}());
exports.InjectorCompiler = InjectorCompiler;
var _InjectorBuilder = (function () {
    function _InjectorBuilder(_mainModuleType) {
        this._mainModuleType = _mainModuleType;
        this._instances = new compile_metadata_1.CompileTokenMap();
        this._fields = [];
        this._ctorStmts = [];
        this._getters = [];
        this._needsMainModule = false;
        this._instances.add(identifiers_1.identifierToken(identifiers_1.Identifiers.Injector), o.THIS_EXPR);
    }
    _InjectorBuilder.prototype.addProvider = function (resolvedProvider) {
        var _this = this;
        var providerValueExpressions = resolvedProvider.providers.map(function (provider) { return _this._getProviderValue(provider); });
        var propName = "_" + resolvedProvider.token.name + "_" + this._instances.size;
        var instance = this._createProviderProperty(propName, resolvedProvider, providerValueExpressions, resolvedProvider.multiProvider, resolvedProvider.eager);
        this._instances.add(resolvedProvider.token, instance);
    };
    _InjectorBuilder.prototype.build = function () {
        var _this = this;
        this._ctorStmts.push(o.SUPER_EXPR.callFn([
            o.variable(parentInjectorProp.name),
            o.literal(this._needsMainModule),
            o.variable(mainModuleProp.name)
        ])
            .toStmt());
        var getMethodStmts = this._instances.keys().map(function (token) {
            var providerExpr = _this._instances.get(token);
            return new o.IfStmt(constants_1.InjectMethodVars.token.identical(util_1.createDiTokenExpression(token)), [new o.ReturnStatement(providerExpr)]);
        });
        getMethodStmts.push(new o.IfStmt(constants_1.InjectMethodVars.token.identical(util_1.createDiTokenExpression(identifiers_1.identifierToken(this._mainModuleType)))
            .and(o.not(mainModuleProp.equals(o.NULL_EXPR))), [new o.ReturnStatement(mainModuleProp)]));
        var methods = [
            new o.ClassMethod('getInternal', [
                new o.FnParam(constants_1.InjectMethodVars.token.name, o.DYNAMIC_TYPE),
                new o.FnParam(constants_1.InjectMethodVars.notFoundResult.name, o.DYNAMIC_TYPE)
            ], getMethodStmts.concat([new o.ReturnStatement(constants_1.InjectMethodVars.notFoundResult)]), o.DYNAMIC_TYPE)
        ];
        var ctor = new o.ClassMethod(null, [
            new o.FnParam(parentInjectorProp.name, o.importType(identifiers_1.Identifiers.Injector)),
            new o.FnParam(mainModuleProp.name, o.importType(this._mainModuleType))
        ], this._ctorStmts);
        var injClassName = this._mainModuleType.name + "Injector";
        return new o.ClassStmt(injClassName, o.importExpr(identifiers_1.Identifiers.CodegenInjector, [o.importType(this._mainModuleType)]), this._fields, this._getters, ctor, methods);
    };
    _InjectorBuilder.prototype._getProviderValue = function (provider) {
        var _this = this;
        var result;
        if (lang_1.isPresent(provider.useExisting)) {
            result = this._getDependency(new compile_metadata_1.CompileDiDependencyMetadata({ token: provider.useExisting }));
        }
        else if (lang_1.isPresent(provider.useFactory)) {
            var deps = lang_1.isPresent(provider.deps) ? provider.deps : provider.useFactory.diDeps;
            var depsExpr = deps.map(function (dep) { return _this._getDependency(dep); });
            result = o.importExpr(provider.useFactory).callFn(depsExpr);
        }
        else if (lang_1.isPresent(provider.useClass)) {
            var deps = lang_1.isPresent(provider.deps) ? provider.deps : provider.useClass.diDeps;
            var depsExpr = deps.map(function (dep) { return _this._getDependency(dep); });
            result =
                o.importExpr(provider.useClass).instantiate(depsExpr, o.importType(provider.useClass));
        }
        else {
            result = util_1.convertValueToOutputAst(provider.useValue);
        }
        if (lang_1.isPresent(provider.useProperty)) {
            result = result.prop(provider.useProperty);
        }
        return result;
    };
    _InjectorBuilder.prototype._createProviderProperty = function (propName, provider, providerValueExpressions, isMulti, isEager) {
        var resolvedProviderValueExpr;
        var type;
        if (isMulti) {
            resolvedProviderValueExpr = o.literalArr(providerValueExpressions);
            type = new o.ArrayType(o.DYNAMIC_TYPE);
        }
        else {
            resolvedProviderValueExpr = providerValueExpressions[0];
            type = providerValueExpressions[0].type;
        }
        if (lang_1.isBlank(type)) {
            type = o.DYNAMIC_TYPE;
        }
        if (isEager) {
            this._fields.push(new o.ClassField(propName, type));
            this._ctorStmts.push(o.THIS_EXPR.prop(propName).set(resolvedProviderValueExpr).toStmt());
        }
        else {
            var internalField = "_" + propName;
            this._fields.push(new o.ClassField(internalField, type));
            // Note: Equals is important for JS so that it also checks the undefined case!
            var getterStmts = [
                new o.IfStmt(o.THIS_EXPR.prop(internalField).isBlank(), [o.THIS_EXPR.prop(internalField).set(resolvedProviderValueExpr).toStmt()]),
                new o.ReturnStatement(o.THIS_EXPR.prop(internalField))
            ];
            this._getters.push(new o.ClassGetter(propName, getterStmts, type));
        }
        return o.THIS_EXPR.prop(propName);
    };
    _InjectorBuilder.prototype._getDependency = function (dep) {
        var result = null;
        if (dep.isValue) {
            result = o.literal(dep.value);
        }
        if (!dep.isSkipSelf) {
            if (lang_1.isBlank(result)) {
                result = this._instances.get(dep.token);
            }
            if (lang_1.isBlank(result) && dep.token.equalsTo(identifiers_1.identifierToken(this._mainModuleType))) {
                this._needsMainModule = true;
                result = mainModuleProp;
            }
        }
        if (lang_1.isBlank(result)) {
            var args = [util_1.createDiTokenExpression(dep.token)];
            if (dep.isOptional) {
                args.push(o.NULL_EXPR);
            }
            result = parentInjectorProp.callMethod('get', args);
        }
        return result;
    };
    return _InjectorBuilder;
}());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5qZWN0b3JfY29tcGlsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJkaWZmaW5nX3BsdWdpbl93cmFwcGVyLW91dHB1dF9wYXRoLUJIc2JSSmQyLnRtcC9hbmd1bGFyMi9zcmMvY29tcGlsZXIvdmlld19jb21waWxlci9pbmplY3Rvcl9jb21waWxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEscUJBQWlDLDBCQUEwQixDQUFDLENBQUE7QUFDNUQsaUNBT08scUJBQXFCLENBQUMsQ0FBQTtBQUM3Qiw0QkFBMkMsZ0JBQWdCLENBQUMsQ0FBQTtBQUM1RCxJQUFZLENBQUMsV0FBTSxzQkFBc0IsQ0FBQyxDQUFBO0FBQzFDLDJCQUE4RCxlQUFlLENBQUMsQ0FBQTtBQUM5RSxnQ0FBZ0Msb0JBQW9CLENBQUMsQ0FBQTtBQUdyRCwwQkFBK0IsYUFBYSxDQUFDLENBQUE7QUFDN0MscUJBQStELFFBQVEsQ0FBQyxDQUFBO0FBRXhFLElBQUksY0FBYyxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3BELElBQUksa0JBQWtCLEdBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7QUFFcEQ7SUFDRSwrQkFBbUIsVUFBeUIsRUFBUyxrQkFBMEI7UUFBNUQsZUFBVSxHQUFWLFVBQVUsQ0FBZTtRQUFTLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBUTtJQUFHLENBQUM7SUFDckYsNEJBQUM7QUFBRCxDQUFDLEFBRkQsSUFFQztBQUZZLDZCQUFxQix3QkFFakMsQ0FBQTtBQUVEO0lBQUE7SUFxQ0EsQ0FBQztJQXBDQywwQ0FBZSxHQUFmLFVBQWdCLGtCQUFpRDtRQUMvRCxJQUFJLE9BQU8sR0FBRyxJQUFJLGdCQUFnQixDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDdkQsSUFBSSxjQUFjLEdBQ2QsZ0JBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxTQUFTLENBQUM7WUFDbkMs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QyxDQUFDLGNBQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3BCLE1BQU0sR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDMUMsQ0FBQztZQUNELEVBQUUsQ0FBQyxDQUFDLGNBQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyw2QkFBZSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDakYsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQztnQkFDN0IsTUFBTSxHQUFHLGNBQWMsQ0FBQztZQUMxQixDQUFDO1FBQ0gsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLGNBQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEIsSUFBSSxJQUFJLEdBQUcsQ0FBQyw4QkFBdUIsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNoRCxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztnQkFDbkIsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDekIsQ0FBQztZQUNELE1BQU0sR0FBRyxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3RELENBQUM7UUFDRCxNQUFNLENBQUMsTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFDSCx1QkFBQztBQUFELENBQUMsQUEvSUQsSUErSUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2lzUHJlc2VudCwgaXNCbGFua30gZnJvbSAnYW5ndWxhcjIvc3JjL2ZhY2FkZS9sYW5nJztcbmltcG9ydCB7XG4gIENvbXBpbGVJbmplY3Rvck1vZHVsZU1ldGFkYXRhLFxuICBDb21waWxlRGlEZXBlbmRlbmN5TWV0YWRhdGEsXG4gIENvbXBpbGVUb2tlbk1ldGFkYXRhLFxuICBDb21waWxlVG9rZW5NYXAsXG4gIENvbXBpbGVQcm92aWRlck1ldGFkYXRhLFxuICBDb21waWxlVHlwZU1ldGFkYXRhXG59IGZyb20gJy4uL2NvbXBpbGVfbWV0YWRhdGEnO1xuaW1wb3J0IHtJZGVudGlmaWVycywgaWRlbnRpZmllclRva2VufSBmcm9tICcuLi9pZGVudGlmaWVycyc7XG5pbXBvcnQgKiBhcyBvIGZyb20gJy4uL291dHB1dC9vdXRwdXRfYXN0JztcbmltcG9ydCB7UGFyc2VTb3VyY2VTcGFuLCBQYXJzZUxvY2F0aW9uLCBQYXJzZVNvdXJjZUZpbGV9IGZyb20gJy4uL3BhcnNlX3V0aWwnO1xuaW1wb3J0IHtBcHBQcm92aWRlclBhcnNlcn0gZnJvbSAnLi4vcHJvdmlkZXJfcGFyc2VyJztcbmltcG9ydCB7UHJvdmlkZXJBc3R9IGZyb20gJy4uL3RlbXBsYXRlX2FzdCc7XG5cbmltcG9ydCB7SW5qZWN0TWV0aG9kVmFyc30gZnJvbSAnLi9jb25zdGFudHMnO1xuaW1wb3J0IHtjcmVhdGVEaVRva2VuRXhwcmVzc2lvbiwgY29udmVydFZhbHVlVG9PdXRwdXRBc3R9IGZyb20gJy4vdXRpbCc7XG5cbnZhciBtYWluTW9kdWxlUHJvcCA9IG8uVEhJU19FWFBSLnByb3AoJ21haW5Nb2R1bGUnKTtcbnZhciBwYXJlbnRJbmplY3RvclByb3AgPSBvLlRISVNfRVhQUi5wcm9wKCdwYXJlbnQnKTtcblxuZXhwb3J0IGNsYXNzIEluamVjdG9yQ29tcGlsZVJlc3VsdCB7XG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBzdGF0ZW1lbnRzOiBvLlN0YXRlbWVudFtdLCBwdWJsaWMgaW5qZWN0b3JGYWN0b3J5VmFyOiBzdHJpbmcpIHt9XG59XG5cbmV4cG9ydCBjbGFzcyBJbmplY3RvckNvbXBpbGVyIHtcbiAgY29tcGlsZUluamVjdG9yKGluamVjdG9yTW9kdWxlTWV0YTogQ29tcGlsZUluamVjdG9yTW9kdWxlTWV0YWRhdGEpOiBJbmplY3RvckNvbXBpbGVSZXN1bHQge1xuICAgIHZhciBidWlsZGVyID0gbmV3IF9JbmplY3RvckJ1aWxkZXIoaW5qZWN0b3JNb2R1bGVNZXRhKTtcbiAgICB2YXIgc291cmNlRmlsZU5hbWUgPVxuICAgICAgICBpc1ByZXNlbnQoaW5qZWN0b3JNb2R1bGVNZXRhLm1vZHVsZVVybCkgP1xuICAgICAgICAgICAgYGluIEluamVjdG9yTW9kdWxlICR7aW5qZWN0b3JNb2R1bGVNZXRhLm5hbWV9IGluICR7aW5qZWN0b3JNb2R1bGVNZXRhLm1vZHVsZVVybH1gIDpcbiAgICAgICAgICAgIGBpbiBJbmplY3Rvck1vZHVsZSAke2luamVjdG9yTW9kdWxlTWV0YS5uYW1lfWA7XG4gICAgdmFyIHNvdXJjZUZpbGUgPSBuZXcgUGFyc2VTb3VyY2VGaWxlKCcnLCBzb3VyY2VGaWxlTmFtZSk7XG4gICAgdmFyIHByb3ZpZGVyUGFyc2VyID1cbiAgICAgICAgbmV3IEFwcFByb3ZpZGVyUGFyc2VyKG5ldyBQYXJzZVNvdXJjZVNwYW4obmV3IFBhcnNlTG9jYXRpb24oc291cmNlRmlsZSwgbnVsbCwgbnVsbCwgbnVsbCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBQYXJzZUxvY2F0aW9uKHNvdXJjZUZpbGUsIG51bGwsIG51bGwsIG51bGwpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluamVjdG9yTW9kdWxlTWV0YS5wcm92aWRlcnMpO1xuICAgIHByb3ZpZGVyUGFyc2VyLnBhcnNlKCkuZm9yRWFjaCgocHJvdmlkZXIpID0+IGJ1aWxkZXIuYWRkUHJvdmlkZXIocHJvdmlkZXIpKTtcbiAgICB2YXIgaW5qZWN0b3JDbGFzcyA9IGJ1aWxkZXIuYnVpbGQoKTtcbiAgICB2YXIgaW5qZWN0b3JGYWN0b3J5VmFyID0gYCR7aW5qZWN0b3JDbGFzcy5uYW1lfUZhY3RvcnlgO1xuICAgIHZhciBpbmplY3RvckZhY3RvcnlGblZhciA9IGAke2luamVjdG9yQ2xhc3MubmFtZX1GYWN0b3J5Q2xvc3VyZWA7XG4gICAgdmFyIGluamVjdG9yRmFjdG9yeUZuID1cbiAgICAgICAgby5mbihpbmplY3RvckNsYXNzLmNvbnN0cnVjdG9yTWV0aG9kLnBhcmFtcyxcbiAgICAgICAgICAgICBbXG4gICAgICAgICAgICAgICBuZXcgby5SZXR1cm5TdGF0ZW1lbnQoby52YXJpYWJsZShpbmplY3RvckNsYXNzLm5hbWUpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5pbnN0YW50aWF0ZShpbmplY3RvckNsYXNzLmNvbnN0cnVjdG9yTWV0aG9kLnBhcmFtcy5tYXAoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAocGFyYW0pID0+IG8udmFyaWFibGUocGFyYW0ubmFtZSkpKSlcbiAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgIG8uaW1wb3J0VHlwZShJZGVudGlmaWVycy5JbmplY3RvcikpXG4gICAgICAgICAgICAudG9EZWNsU3RtdChpbmplY3RvckZhY3RvcnlGblZhcik7XG4gICAgdmFyIGluamVjdG9yRmFjdG9yeVN0bXQgPVxuICAgICAgICBvLnZhcmlhYmxlKGluamVjdG9yRmFjdG9yeVZhcilcbiAgICAgICAgICAgIC5zZXQoby5pbXBvcnRFeHByKElkZW50aWZpZXJzLkluamVjdG9yRmFjdG9yeSwgW28uaW1wb3J0VHlwZShpbmplY3Rvck1vZHVsZU1ldGEpXSlcbiAgICAgICAgICAgICAgICAgICAgIC5pbnN0YW50aWF0ZShcbiAgICAgICAgICAgICAgICAgICAgICAgICBbby52YXJpYWJsZShpbmplY3RvckZhY3RvcnlGblZhcildLFxuICAgICAgICAgICAgICAgICAgICAgICAgIG8uaW1wb3J0VHlwZShJZGVudGlmaWVycy5JbmplY3RvckZhY3RvcnksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtvLmltcG9ydFR5cGUoaW5qZWN0b3JNb2R1bGVNZXRhKV0sIFtvLlR5cGVNb2RpZmllci5Db25zdF0pKSlcbiAgICAgICAgICAgIC50b0RlY2xTdG10KG51bGwsIFtvLlN0bXRNb2RpZmllci5GaW5hbF0pO1xuXG4gICAgcmV0dXJuIG5ldyBJbmplY3RvckNvbXBpbGVSZXN1bHQoW2luamVjdG9yQ2xhc3MsIGluamVjdG9yRmFjdG9yeUZuLCBpbmplY3RvckZhY3RvcnlTdG10XSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmplY3RvckZhY3RvcnlWYXIpO1xuICB9XG59XG5cblxuY2xhc3MgX0luamVjdG9yQnVpbGRlciB7XG4gIHByaXZhdGUgX2luc3RhbmNlcyA9IG5ldyBDb21waWxlVG9rZW5NYXA8by5FeHByZXNzaW9uPigpO1xuICBwcml2YXRlIF9maWVsZHM6IG8uQ2xhc3NGaWVsZFtdID0gW107XG4gIHByaXZhdGUgX2N0b3JTdG10czogby5TdGF0ZW1lbnRbXSA9IFtdO1xuICBwcml2YXRlIF9nZXR0ZXJzOiBvLkNsYXNzR2V0dGVyW10gPSBbXTtcbiAgcHJpdmF0ZSBfbmVlZHNNYWluTW9kdWxlOiBib29sZWFuID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBfbWFpbk1vZHVsZVR5cGU6IENvbXBpbGVJbmplY3Rvck1vZHVsZU1ldGFkYXRhKSB7XG4gICAgdGhpcy5faW5zdGFuY2VzLmFkZChpZGVudGlmaWVyVG9rZW4oSWRlbnRpZmllcnMuSW5qZWN0b3IpLCBvLlRISVNfRVhQUik7XG4gIH1cblxuICBhZGRQcm92aWRlcihyZXNvbHZlZFByb3ZpZGVyOiBQcm92aWRlckFzdCkge1xuICAgIHZhciBwcm92aWRlclZhbHVlRXhwcmVzc2lvbnMgPVxuICAgICAgICByZXNvbHZlZFByb3ZpZGVyLnByb3ZpZGVycy5tYXAoKHByb3ZpZGVyKSA9PiB0aGlzLl9nZXRQcm92aWRlclZhbHVlKHByb3ZpZGVyKSk7XG4gICAgdmFyIHByb3BOYW1lID0gYF8ke3Jlc29sdmVkUHJvdmlkZXIudG9rZW4ubmFtZX1fJHt0aGlzLl9pbnN0YW5jZXMuc2l6ZX1gO1xuICAgIHZhciBpbnN0YW5jZSA9XG4gICAgICAgIHRoaXMuX2NyZWF0ZVByb3ZpZGVyUHJvcGVydHkocHJvcE5hbWUsIHJlc29sdmVkUHJvdmlkZXIsIHByb3ZpZGVyVmFsdWVFeHByZXNzaW9ucyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlZFByb3ZpZGVyLm11bHRpUHJvdmlkZXIsIHJlc29sdmVkUHJvdmlkZXIuZWFnZXIpO1xuICAgIHRoaXMuX2luc3RhbmNlcy5hZGQocmVzb2x2ZWRQcm92aWRlci50b2tlbiwgaW5zdGFuY2UpO1xuICB9XG5cbiAgYnVpbGQoKTogby5DbGFzc1N0bXQge1xuICAgIHRoaXMuX2N0b3JTdG10cy5wdXNoKG8uU1VQRVJfRVhQUi5jYWxsRm4oW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgby52YXJpYWJsZShwYXJlbnRJbmplY3RvclByb3AubmFtZSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvLmxpdGVyYWwodGhpcy5fbmVlZHNNYWluTW9kdWxlKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG8udmFyaWFibGUobWFpbk1vZHVsZVByb3AubmFtZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudG9TdG10KCkpO1xuXG4gICAgbGV0IGdldE1ldGhvZFN0bXRzOiBvLlN0YXRlbWVudFtdID0gdGhpcy5faW5zdGFuY2VzLmtleXMoKS5tYXAoKHRva2VuKSA9PiB7XG4gICAgICB2YXIgcHJvdmlkZXJFeHByID0gdGhpcy5faW5zdGFuY2VzLmdldCh0b2tlbik7XG4gICAgICByZXR1cm4gbmV3IG8uSWZTdG10KEluamVjdE1ldGhvZFZhcnMudG9rZW4uaWRlbnRpY2FsKGNyZWF0ZURpVG9rZW5FeHByZXNzaW9uKHRva2VuKSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgIFtuZXcgby5SZXR1cm5TdGF0ZW1lbnQocHJvdmlkZXJFeHByKV0pO1xuICAgIH0pO1xuICAgIGdldE1ldGhvZFN0bXRzLnB1c2gobmV3IG8uSWZTdG10KFxuICAgICAgICBJbmplY3RNZXRob2RWYXJzLnRva2VuLmlkZW50aWNhbChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVEaVRva2VuRXhwcmVzc2lvbihpZGVudGlmaWVyVG9rZW4odGhpcy5fbWFpbk1vZHVsZVR5cGUpKSlcbiAgICAgICAgICAgIC5hbmQoby5ub3QobWFpbk1vZHVsZVByb3AuZXF1YWxzKG8uTlVMTF9FWFBSKSkpLFxuICAgICAgICBbbmV3IG8uUmV0dXJuU3RhdGVtZW50KG1haW5Nb2R1bGVQcm9wKV0pKTtcblxuICAgIHZhciBtZXRob2RzID0gW1xuICAgICAgbmV3IG8uQ2xhc3NNZXRob2QoXG4gICAgICAgICAgJ2dldEludGVybmFsJyxcbiAgICAgICAgICBbXG4gICAgICAgICAgICBuZXcgby5GblBhcmFtKEluamVjdE1ldGhvZFZhcnMudG9rZW4ubmFtZSwgby5EWU5BTUlDX1RZUEUpLFxuICAgICAgICAgICAgbmV3IG8uRm5QYXJhbShJbmplY3RNZXRob2RWYXJzLm5vdEZvdW5kUmVzdWx0Lm5hbWUsIG8uRFlOQU1JQ19UWVBFKVxuICAgICAgICAgIF0sXG4gICAgICAgICAgZ2V0TWV0aG9kU3RtdHMuY29uY2F0KFtuZXcgby5SZXR1cm5TdGF0ZW1lbnQoSW5qZWN0TWV0aG9kVmFycy5ub3RGb3VuZFJlc3VsdCldKSxcbiAgICAgICAgICBvLkRZTkFNSUNfVFlQRSlcbiAgICBdO1xuXG4gICAgdmFyIGN0b3IgPSBuZXcgby5DbGFzc01ldGhvZChcbiAgICAgICAgbnVsbCxcbiAgICAgICAgW1xuICAgICAgICAgIG5ldyBvLkZuUGFyYW0ocGFyZW50SW5qZWN0b3JQcm9wLm5hbWUsIG8uaW1wb3J0VHlwZShJZGVudGlmaWVycy5JbmplY3RvcikpLFxuICAgICAgICAgIG5ldyBvLkZuUGFyYW0obWFpbk1vZHVsZVByb3AubmFtZSwgby5pbXBvcnRUeXBlKHRoaXMuX21haW5Nb2R1bGVUeXBlKSlcbiAgICAgICAgXSxcbiAgICAgICAgdGhpcy5fY3RvclN0bXRzKTtcblxuICAgIHZhciBpbmpDbGFzc05hbWUgPSBgJHt0aGlzLl9tYWluTW9kdWxlVHlwZS5uYW1lfUluamVjdG9yYDtcbiAgICByZXR1cm4gbmV3IG8uQ2xhc3NTdG10KGluakNsYXNzTmFtZSwgby5pbXBvcnRFeHByKElkZW50aWZpZXJzLkNvZGVnZW5JbmplY3RvcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFtvLmltcG9ydFR5cGUodGhpcy5fbWFpbk1vZHVsZVR5cGUpXSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9maWVsZHMsIHRoaXMuX2dldHRlcnMsIGN0b3IsIG1ldGhvZHMpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0UHJvdmlkZXJWYWx1ZShwcm92aWRlcjogQ29tcGlsZVByb3ZpZGVyTWV0YWRhdGEpOiBvLkV4cHJlc3Npb24ge1xuICAgIHZhciByZXN1bHQ6IG8uRXhwcmVzc2lvbjtcbiAgICBpZiAoaXNQcmVzZW50KHByb3ZpZGVyLnVzZUV4aXN0aW5nKSkge1xuICAgICAgcmVzdWx0ID0gdGhpcy5fZ2V0RGVwZW5kZW5jeShuZXcgQ29tcGlsZURpRGVwZW5kZW5jeU1ldGFkYXRhKHt0b2tlbjogcHJvdmlkZXIudXNlRXhpc3Rpbmd9KSk7XG4gICAgfSBlbHNlIGlmIChpc1ByZXNlbnQocHJvdmlkZXIudXNlRmFjdG9yeSkpIHtcbiAgICAgIHZhciBkZXBzID0gaXNQcmVzZW50KHByb3ZpZGVyLmRlcHMpID8gcHJvdmlkZXIuZGVwcyA6IHByb3ZpZGVyLnVzZUZhY3RvcnkuZGlEZXBzO1xuICAgICAgdmFyIGRlcHNFeHByID0gZGVwcy5tYXAoKGRlcCkgPT4gdGhpcy5fZ2V0RGVwZW5kZW5jeShkZXApKTtcbiAgICAgIHJlc3VsdCA9IG8uaW1wb3J0RXhwcihwcm92aWRlci51c2VGYWN0b3J5KS5jYWxsRm4oZGVwc0V4cHIpO1xuICAgIH0gZWxzZSBpZiAoaXNQcmVzZW50KHByb3ZpZGVyLnVzZUNsYXNzKSkge1xuICAgICAgdmFyIGRlcHMgPSBpc1ByZXNlbnQocHJvdmlkZXIuZGVwcykgPyBwcm92aWRlci5kZXBzIDogcHJvdmlkZXIudXNlQ2xhc3MuZGlEZXBzO1xuICAgICAgdmFyIGRlcHNFeHByID0gZGVwcy5tYXAoKGRlcCkgPT4gdGhpcy5fZ2V0RGVwZW5kZW5jeShkZXApKTtcbiAgICAgIHJlc3VsdCA9XG4gICAgICAgICAgby5pbXBvcnRFeHByKHByb3ZpZGVyLnVzZUNsYXNzKS5pbnN0YW50aWF0ZShkZXBzRXhwciwgby5pbXBvcnRUeXBlKHByb3ZpZGVyLnVzZUNsYXNzKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc3VsdCA9IGNvbnZlcnRWYWx1ZVRvT3V0cHV0QXN0KHByb3ZpZGVyLnVzZVZhbHVlKTtcbiAgICB9XG4gICAgaWYgKGlzUHJlc2VudChwcm92aWRlci51c2VQcm9wZXJ0eSkpIHtcbiAgICAgIHJlc3VsdCA9IHJlc3VsdC5wcm9wKHByb3ZpZGVyLnVzZVByb3BlcnR5KTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG5cbiAgcHJpdmF0ZSBfY3JlYXRlUHJvdmlkZXJQcm9wZXJ0eShwcm9wTmFtZTogc3RyaW5nLCBwcm92aWRlcjogUHJvdmlkZXJBc3QsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvdmlkZXJWYWx1ZUV4cHJlc3Npb25zOiBvLkV4cHJlc3Npb25bXSwgaXNNdWx0aTogYm9vbGVhbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0VhZ2VyOiBib29sZWFuKTogby5FeHByZXNzaW9uIHtcbiAgICB2YXIgcmVzb2x2ZWRQcm92aWRlclZhbHVlRXhwcjtcbiAgICB2YXIgdHlwZTtcbiAgICBpZiAoaXNNdWx0aSkge1xuICAgICAgcmVzb2x2ZWRQcm92aWRlclZhbHVlRXhwciA9IG8ubGl0ZXJhbEFycihwcm92aWRlclZhbHVlRXhwcmVzc2lvbnMpO1xuICAgICAgdHlwZSA9IG5ldyBvLkFycmF5VHlwZShvLkRZTkFNSUNfVFlQRSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc29sdmVkUHJvdmlkZXJWYWx1ZUV4cHIgPSBwcm92aWRlclZhbHVlRXhwcmVzc2lvbnNbMF07XG4gICAgICB0eXBlID0gcHJvdmlkZXJWYWx1ZUV4cHJlc3Npb25zWzBdLnR5cGU7XG4gICAgfVxuICAgIGlmIChpc0JsYW5rKHR5cGUpKSB7XG4gICAgICB0eXBlID0gby5EWU5BTUlDX1RZUEU7XG4gICAgfVxuICAgIGlmIChpc0VhZ2VyKSB7XG4gICAgICB0aGlzLl9maWVsZHMucHVzaChuZXcgby5DbGFzc0ZpZWxkKHByb3BOYW1lLCB0eXBlKSk7XG4gICAgICB0aGlzLl9jdG9yU3RtdHMucHVzaChvLlRISVNfRVhQUi5wcm9wKHByb3BOYW1lKS5zZXQocmVzb2x2ZWRQcm92aWRlclZhbHVlRXhwcikudG9TdG10KCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB2YXIgaW50ZXJuYWxGaWVsZCA9IGBfJHtwcm9wTmFtZX1gO1xuICAgICAgdGhpcy5fZmllbGRzLnB1c2gobmV3IG8uQ2xhc3NGaWVsZChpbnRlcm5hbEZpZWxkLCB0eXBlKSk7XG4gICAgICAvLyBOb3RlOiBFcXVhbHMgaXMgaW1wb3J0YW50IGZvciBKUyBzbyB0aGF0IGl0IGFsc28gY2hlY2tzIHRoZSB1bmRlZmluZWQgY2FzZSFcbiAgICAgIHZhciBnZXR0ZXJTdG10cyA9IFtcbiAgICAgICAgbmV3IG8uSWZTdG10KG8uVEhJU19FWFBSLnByb3AoaW50ZXJuYWxGaWVsZCkuaXNCbGFuaygpLFxuICAgICAgICAgICAgICAgICAgICAgW28uVEhJU19FWFBSLnByb3AoaW50ZXJuYWxGaWVsZCkuc2V0KHJlc29sdmVkUHJvdmlkZXJWYWx1ZUV4cHIpLnRvU3RtdCgpXSksXG4gICAgICAgIG5ldyBvLlJldHVyblN0YXRlbWVudChvLlRISVNfRVhQUi5wcm9wKGludGVybmFsRmllbGQpKVxuICAgICAgXTtcbiAgICAgIHRoaXMuX2dldHRlcnMucHVzaChuZXcgby5DbGFzc0dldHRlcihwcm9wTmFtZSwgZ2V0dGVyU3RtdHMsIHR5cGUpKTtcbiAgICB9XG4gICAgcmV0dXJuIG8uVEhJU19FWFBSLnByb3AocHJvcE5hbWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0RGVwZW5kZW5jeShkZXA6IENvbXBpbGVEaURlcGVuZGVuY3lNZXRhZGF0YSk6IG8uRXhwcmVzc2lvbiB7XG4gICAgdmFyIHJlc3VsdCA9IG51bGw7XG4gICAgaWYgKGRlcC5pc1ZhbHVlKSB7XG4gICAgICByZXN1bHQgPSBvLmxpdGVyYWwoZGVwLnZhbHVlKTtcbiAgICB9XG4gICAgaWYgKCFkZXAuaXNTa2lwU2VsZikge1xuICAgICAgaWYgKGlzQmxhbmsocmVzdWx0KSkge1xuICAgICAgICByZXN1bHQgPSB0aGlzLl9pbnN0YW5jZXMuZ2V0KGRlcC50b2tlbik7XG4gICAgICB9XG4gICAgICBpZiAoaXNCbGFuayhyZXN1bHQpICYmIGRlcC50b2tlbi5lcXVhbHNUbyhpZGVudGlmaWVyVG9rZW4odGhpcy5fbWFpbk1vZHVsZVR5cGUpKSkge1xuICAgICAgICB0aGlzLl9uZWVkc01haW5Nb2R1bGUgPSB0cnVlO1xuICAgICAgICByZXN1bHQgPSBtYWluTW9kdWxlUHJvcDtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGlzQmxhbmsocmVzdWx0KSkge1xuICAgICAgdmFyIGFyZ3MgPSBbY3JlYXRlRGlUb2tlbkV4cHJlc3Npb24oZGVwLnRva2VuKV07XG4gICAgICBpZiAoZGVwLmlzT3B0aW9uYWwpIHtcbiAgICAgICAgYXJncy5wdXNoKG8uTlVMTF9FWFBSKTtcbiAgICAgIH1cbiAgICAgIHJlc3VsdCA9IHBhcmVudEluamVjdG9yUHJvcC5jYWxsTWV0aG9kKCdnZXQnLCBhcmdzKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxufVxuIl19