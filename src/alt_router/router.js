'use strict';"use strict";
var core_1 = require('angular2/core');
var lang_1 = require('angular2/src/facade/lang');
var collection_1 = require('angular2/src/facade/collection');
var async_1 = require('angular2/src/facade/async');
var collection_2 = require('angular2/src/facade/collection');
var exceptions_1 = require('angular2/src/facade/exceptions');
var recognize_1 = require('./recognize');
var link_1 = require('./link');
var segments_1 = require('./segments');
var lifecycle_reflector_1 = require('./lifecycle_reflector');
var constants_1 = require('./constants');
var RouterOutletMap = (function () {
    function RouterOutletMap() {
        /** @internal */
        this._outlets = {};
    }
    RouterOutletMap.prototype.registerOutlet = function (name, outlet) { this._outlets[name] = outlet; };
    return RouterOutletMap;
}());
exports.RouterOutletMap = RouterOutletMap;
var Router = (function () {
    function Router(_rootComponent, _rootComponentType, _componentResolver, _urlSerializer, _routerOutletMap, _location) {
        this._rootComponent = _rootComponent;
        this._rootComponentType = _rootComponentType;
        this._componentResolver = _componentResolver;
        this._urlSerializer = _urlSerializer;
        this._routerOutletMap = _routerOutletMap;
        this._location = _location;
        this._changes = new async_1.EventEmitter();
        this.navigateByUrl(this._location.path());
    }
    Object.defineProperty(Router.prototype, "urlTree", {
        get: function () { return this._urlTree; },
        enumerable: true,
        configurable: true
    });
    Router.prototype.navigateByUrl = function (url) {
        return this._navigate(this._urlSerializer.parse(url));
    };
    Router.prototype.navigate = function (changes, segment) {
        return this._navigate(this.createUrlTree(changes, segment));
    };
    Router.prototype._navigate = function (url) {
        var _this = this;
        this._urlTree = url;
        return recognize_1.recognize(this._componentResolver, this._rootComponentType, url)
            .then(function (currTree) {
            return new _LoadSegments(currTree, _this._prevTree)
                .load(_this._routerOutletMap, _this._rootComponent)
                .then(function (updated) {
                if (updated) {
                    _this._prevTree = currTree;
                    _this._location.go(_this._urlSerializer.serialize(_this._urlTree));
                    _this._changes.emit(null);
                }
            });
        });
    };
    Router.prototype.createUrlTree = function (changes, segment) {
        if (lang_1.isPresent(this._prevTree)) {
            var s = lang_1.isPresent(segment) ? segment : this._prevTree.root;
            return link_1.link(s, this._prevTree, this.urlTree, changes);
        }
        else {
            return null;
        }
    };
    Router.prototype.serializeUrl = function (url) { return this._urlSerializer.serialize(url); };
    Object.defineProperty(Router.prototype, "changes", {
        get: function () { return this._changes; },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Router.prototype, "routeTree", {
        get: function () { return this._prevTree; },
        enumerable: true,
        configurable: true
    });
    return Router;
}());
exports.Router = Router;
var _LoadSegments = (function () {
    function _LoadSegments(currTree, prevTree) {
        this.currTree = currTree;
        this.prevTree = prevTree;
        this.deactivations = [];
        this.performMutation = true;
    }
    _LoadSegments.prototype.load = function (parentOutletMap, rootComponent) {
        var _this = this;
        var prevRoot = lang_1.isPresent(this.prevTree) ? segments_1.rootNode(this.prevTree) : null;
        var currRoot = segments_1.rootNode(this.currTree);
        return this.canDeactivate(currRoot, prevRoot, parentOutletMap, rootComponent)
            .then(function (res) {
            _this.performMutation = true;
            if (res) {
                _this.loadChildSegments(currRoot, prevRoot, parentOutletMap, [rootComponent]);
            }
            return res;
        });
    };
    _LoadSegments.prototype.canDeactivate = function (currRoot, prevRoot, outletMap, rootComponent) {
        var _this = this;
        this.performMutation = false;
        this.loadChildSegments(currRoot, prevRoot, outletMap, [rootComponent]);
        var allPaths = async_1.PromiseWrapper.all(this.deactivations.map(function (r) { return _this.checkCanDeactivatePath(r); }));
        return allPaths.then(function (values) { return values.filter(function (v) { return v; }).length === values.length; });
    };
    _LoadSegments.prototype.checkCanDeactivatePath = function (path) {
        var _this = this;
        var curr = async_1.PromiseWrapper.resolve(true);
        var _loop_1 = function(p) {
            curr = curr.then(function (_) {
                if (lifecycle_reflector_1.hasLifecycleHook("routerCanDeactivate", p)) {
                    return p.routerCanDeactivate(_this.prevTree, _this.currTree);
                }
                else {
                    return _;
                }
            });
        };
        for (var _i = 0, _a = collection_1.ListWrapper.reversed(path); _i < _a.length; _i++) {
            var p = _a[_i];
            _loop_1(p);
        }
        return curr;
    };
    _LoadSegments.prototype.loadChildSegments = function (currNode, prevNode, outletMap, components) {
        var _this = this;
        var prevChildren = lang_1.isPresent(prevNode) ?
            prevNode.children.reduce(function (m, c) {
                m[c.value.outlet] = c;
                return m;
            }, {}) :
            {};
        currNode.children.forEach(function (c) {
            _this.loadSegments(c, prevChildren[c.value.outlet], outletMap, components);
            collection_2.StringMapWrapper.delete(prevChildren, c.value.outlet);
        });
        collection_2.StringMapWrapper.forEach(prevChildren, function (v, k) { return _this.unloadOutlet(outletMap._outlets[k], components); });
    };
    _LoadSegments.prototype.loadSegments = function (currNode, prevNode, parentOutletMap, components) {
        var curr = currNode.value;
        var prev = lang_1.isPresent(prevNode) ? prevNode.value : null;
        var outlet = this.getOutlet(parentOutletMap, currNode.value);
        if (segments_1.equalSegments(curr, prev)) {
            this.loadChildSegments(currNode, prevNode, outlet.outletMap, components.concat([outlet.loadedComponent]));
        }
        else {
            this.unloadOutlet(outlet, components);
            if (this.performMutation) {
                var outletMap = new RouterOutletMap();
                var loadedComponent = this.loadNewSegment(outletMap, curr, prev, outlet);
                this.loadChildSegments(currNode, prevNode, outletMap, components.concat([loadedComponent]));
            }
        }
    };
    _LoadSegments.prototype.loadNewSegment = function (outletMap, curr, prev, outlet) {
        var resolved = core_1.ReflectiveInjector.resolve([core_1.provide(RouterOutletMap, { useValue: outletMap }), core_1.provide(segments_1.RouteSegment, { useValue: curr })]);
        var ref = outlet.load(segments_1.routeSegmentComponentFactory(curr), resolved, outletMap);
        if (lifecycle_reflector_1.hasLifecycleHook("routerOnActivate", ref.instance)) {
            ref.instance.routerOnActivate(curr, prev, this.currTree, this.prevTree);
        }
        return ref.instance;
    };
    _LoadSegments.prototype.getOutlet = function (outletMap, segment) {
        var outlet = outletMap._outlets[segment.outlet];
        if (lang_1.isBlank(outlet)) {
            if (segment.outlet == constants_1.DEFAULT_OUTLET_NAME) {
                throw new exceptions_1.BaseException("Cannot find default outlet");
            }
            else {
                throw new exceptions_1.BaseException("Cannot find the outlet " + segment.outlet);
            }
        }
        return outlet;
    };
    _LoadSegments.prototype.unloadOutlet = function (outlet, components) {
        var _this = this;
        if (lang_1.isPresent(outlet) && outlet.isLoaded) {
            collection_2.StringMapWrapper.forEach(outlet.outletMap._outlets, function (v, k) { return _this.unloadOutlet(v, components); });
            if (this.performMutation) {
                outlet.unload();
            }
            else {
                this.deactivations.push(components.concat([outlet.loadedComponent]));
            }
        }
    };
    return _LoadSegments;
}());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZGlmZmluZ19wbHVnaW5fd3JhcHBlci1vdXRwdXRfcGF0aC1RZ0VnV1hubS50bXAvYW5ndWxhcjIvc3JjL2FsdF9yb3V0ZXIvcm91dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxxQkFBcUUsZUFBZSxDQUFDLENBQUE7QUFFckYscUJBQXVDLDBCQUEwQixDQUFDLENBQUE7QUFDbEUsMkJBQTBCLGdDQUFnQyxDQUFDLENBQUE7QUFDM0Qsc0JBQXVELDJCQUEyQixDQUFDLENBQUE7QUFDbkYsMkJBQStCLGdDQUFnQyxDQUFDLENBQUE7QUFDaEUsMkJBQTRCLGdDQUFnQyxDQUFDLENBQUE7QUFHN0QsMEJBQXdCLGFBQWEsQ0FBQyxDQUFBO0FBRXRDLHFCQUFtQixRQUFRLENBQUMsQ0FBQTtBQUU1Qix5QkFTTyxZQUFZLENBQUMsQ0FBQTtBQUNwQixvQ0FBK0IsdUJBQXVCLENBQUMsQ0FBQTtBQUN2RCwwQkFBa0MsYUFBYSxDQUFDLENBQUE7QUFFaEQ7SUFBQTtRQUNFLGdCQUFnQjtRQUNoQixhQUFRLEdBQW1DLEVBQUUsQ0FBQztJQUVoRCxDQUFDO0lBREMsd0NBQWMsR0FBZCxVQUFlLElBQVksRUFBRSxNQUFvQixJQUFVLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUM1RixzQkFBQztBQUFELENBQUMsQUFKRCxJQUlDO0FBSlksdUJBQWUsa0JBSTNCLENBQUE7QUFFRDtJQU1FLGdCQUFvQixjQUFzQixFQUFVLGtCQUF3QixFQUN4RCxrQkFBcUMsRUFDckMsY0FBbUMsRUFDbkMsZ0JBQWlDLEVBQVUsU0FBbUI7UUFIOUQsbUJBQWMsR0FBZCxjQUFjLENBQVE7UUFBVSx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQU07UUFDeEQsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFtQjtRQUNyQyxtQkFBYyxHQUFkLGNBQWMsQ0FBcUI7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QUUsQ0FBQyxJQUFLLE9BQUEsS0FBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLEVBQUUsVUFBVSxDQUFDLEVBQWhDLENBQWdDLENBQUMsQ0FBQztZQUNyRSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztnQkFDekIsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ2xCLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDTixJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN2RSxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7SUFDSCxvQkFBQztBQUFELENBQUMsQUFwSEQsSUFvSEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge09uSW5pdCwgcHJvdmlkZSwgUmVmbGVjdGl2ZUluamVjdG9yLCBDb21wb25lbnRSZXNvbHZlcn0gZnJvbSAnYW5ndWxhcjIvY29yZSc7XG5pbXBvcnQge1JvdXRlck91dGxldH0gZnJvbSAnLi9kaXJlY3RpdmVzL3JvdXRlcl9vdXRsZXQnO1xuaW1wb3J0IHtUeXBlLCBpc0JsYW5rLCBpc1ByZXNlbnR9IGZyb20gJ2FuZ3VsYXIyL3NyYy9mYWNhZGUvbGFuZyc7XG5pbXBvcnQge0xpc3RXcmFwcGVyfSBmcm9tICdhbmd1bGFyMi9zcmMvZmFjYWRlL2NvbGxlY3Rpb24nO1xuaW1wb3J0IHtFdmVudEVtaXR0ZXIsIE9ic2VydmFibGUsIFByb21pc2VXcmFwcGVyfSBmcm9tICdhbmd1bGFyMi9zcmMvZmFjYWRlL2FzeW5jJztcbmltcG9ydCB7U3RyaW5nTWFwV3JhcHBlcn0gZnJvbSAnYW5ndWxhcjIvc3JjL2ZhY2FkZS9jb2xsZWN0aW9uJztcbmltcG9ydCB7QmFzZUV4Y2VwdGlvbn0gZnJvbSAnYW5ndWxhcjIvc3JjL2ZhY2FkZS9leGNlcHRpb25zJztcbmltcG9ydCB7Um91dGVyVXJsU2VyaWFsaXplcn0gZnJvbSAnLi9yb3V0ZXJfdXJsX3NlcmlhbGl6ZXInO1xuaW1wb3J0IHtDYW5EZWFjdGl2YXRlfSBmcm9tICcuL2ludGVyZmFjZXMnO1xuaW1wb3J0IHtyZWNvZ25pemV9IGZyb20gJy4vcmVjb2duaXplJztcbmltcG9ydCB7TG9jYXRpb259IGZyb20gJ2FuZ3VsYXIyL3BsYXRmb3JtL2NvbW1vbic7XG5pbXBvcnQge2xpbmt9IGZyb20gJy4vbGluayc7XG5cbmltcG9ydCB7XG4gIGVxdWFsU2VnbWVudHMsXG4gIHJvdXRlU2VnbWVudENvbXBvbmVudEZhY3RvcnksXG4gIFJvdXRlU2VnbWVudCxcbiAgVHJlZSxcbiAgcm9vdE5vZGUsXG4gIFRyZWVOb2RlLFxuICBVcmxTZWdtZW50LFxuICBzZXJpYWxpemVSb3V0ZVNlZ21lbnRUcmVlXG59IGZyb20gJy4vc2VnbWVudHMnO1xuaW1wb3J0IHtoYXNMaWZlY3ljbGVIb29rfSBmcm9tICcuL2xpZmVjeWNsZV9yZWZsZWN0b3InO1xuaW1wb3J0IHtERUZBVUxUX09VVExFVF9OQU1FfSBmcm9tICcuL2NvbnN0YW50cyc7XG5cbmV4cG9ydCBjbGFzcyBSb3V0ZXJPdXRsZXRNYXAge1xuICAvKiogQGludGVybmFsICovXG4gIF9vdXRsZXRzOiB7W25hbWU6IHN0cmluZ106IFJvdXRlck91dGxldH0gPSB7fTtcbiAgcmVnaXN0ZXJPdXRsZXQobmFtZTogc3RyaW5nLCBvdXRsZXQ6IFJvdXRlck91dGxldCk6IHZvaWQgeyB0aGlzLl9vdXRsZXRzW25hbWVdID0gb3V0bGV0OyB9XG59XG5cbmV4cG9ydCBjbGFzcyBSb3V0ZXIge1xuICBwcml2YXRlIF9wcmV2VHJlZTogVHJlZTxSb3V0ZVNlZ21lbnQ+O1xuICBwcml2YXRlIF91cmxUcmVlOiBUcmVlPFVybFNlZ21lbnQ+O1xuXG4gIHByaXZhdGUgX2NoYW5nZXM6IEV2ZW50RW1pdHRlcjx2b2lkPiA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9yb290Q29tcG9uZW50OiBPYmplY3QsIHByaXZhdGUgX3Jvb3RDb21wb25lbnRUeXBlOiBUeXBlLFxuICAgICAgICAgICAgICBwcml2YXRlIF9jb21wb25lbnRSZXNvbHZlcjogQ29tcG9uZW50UmVzb2x2ZXIsXG4gICAgICAgICAgICAgIHByaXZhdGUgX3VybFNlcmlhbGl6ZXI6IFJvdXRlclVybFNlcmlhbGl6ZXIsXG4gICAgICAgICAgICAgIHByaXZhdGUgX3JvdXRlck91dGxldE1hcDogUm91dGVyT3V0bGV0TWFwLCBwcml2YXRlIF9sb2NhdGlvbjogTG9jYXRpb24pIHtcbiAgICB0aGlzLm5hdmlnYXRlQnlVcmwodGhpcy5fbG9jYXRpb24ucGF0aCgpKTtcbiAgfVxuXG4gIGdldCB1cmxUcmVlKCk6IFRyZWU8VXJsU2VnbWVudD4geyByZXR1cm4gdGhpcy5fdXJsVHJlZTsgfVxuXG4gIG5hdmlnYXRlQnlVcmwodXJsOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gdGhpcy5fbmF2aWdhdGUodGhpcy5fdXJsU2VyaWFsaXplci5wYXJzZSh1cmwpKTtcbiAgfVxuXG4gIG5hdmlnYXRlKGNoYW5nZXM6IGFueVtdLCBzZWdtZW50PzogUm91dGVTZWdtZW50KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIHRoaXMuX25hdmlnYXRlKHRoaXMuY3JlYXRlVXJsVHJlZShjaGFuZ2VzLCBzZWdtZW50KSk7XG4gIH1cblxuICBwcml2YXRlIF9uYXZpZ2F0ZSh1cmw6IFRyZWU8VXJsU2VnbWVudD4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLl91cmxUcmVlID0gdXJsO1xuICAgIHJldHVybiByZWNvZ25pemUodGhpcy5fY29tcG9uZW50UmVzb2x2ZXIsIHRoaXMuX3Jvb3RDb21wb25lbnRUeXBlLCB1cmwpXG4gICAgICAgIC50aGVuKGN1cnJUcmVlID0+IHtcbiAgICAgICAgICByZXR1cm4gbmV3IF9Mb2FkU2VnbWVudHMoY3VyclRyZWUsIHRoaXMuX3ByZXZUcmVlKVxuICAgICAgICAgICAgICAubG9hZCh0aGlzLl9yb3V0ZXJPdXRsZXRNYXAsIHRoaXMuX3Jvb3RDb21wb25lbnQpXG4gICAgICAgICAgICAgIC50aGVuKHVwZGF0ZWQgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh1cGRhdGVkKSB7XG4gICAgICAgICAgICAgICAgICB0aGlzLl9wcmV2VHJlZSA9IGN1cnJUcmVlO1xuICAgICAgICAgICAgICAgICAgdGhpcy5fbG9jYXRpb24uZ28odGhpcy5fdXJsU2VyaWFsaXplci5zZXJpYWxpemUodGhpcy5fdXJsVHJlZSkpO1xuICAgICAgICAgICAgICAgICAgdGhpcy5fY2hhbmdlcy5lbWl0KG51bGwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICB9XG5cbiAgY3JlYXRlVXJsVHJlZShjaGFuZ2VzOiBhbnlbXSwgc2VnbWVudD86IFJvdXRlU2VnbWVudCk6IFRyZWU8VXJsU2VnbWVudD4ge1xuICAgIGlmIChpc1ByZXNlbnQodGhpcy5fcHJldlRyZWUpKSB7XG4gICAgICBsZXQgcyA9IGlzUHJlc2VudChzZWdtZW50KSA/IHNlZ21lbnQgOiB0aGlzLl9wcmV2VHJlZS5yb290O1xuICAgICAgcmV0dXJuIGxpbmsocywgdGhpcy5fcHJldlRyZWUsIHRoaXMudXJsVHJlZSwgY2hhbmdlcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIHNlcmlhbGl6ZVVybCh1cmw6IFRyZWU8VXJsU2VnbWVudD4pOiBzdHJpbmcgeyByZXR1cm4gdGhpcy5fdXJsU2VyaWFsaXplci5zZXJpYWxpemUodXJsKTsgfVxuXG4gIGdldCBjaGFuZ2VzKCk6IE9ic2VydmFibGU8dm9pZD4geyByZXR1cm4gdGhpcy5fY2hhbmdlczsgfVxuXG4gIGdldCByb3V0ZVRyZWUoKTogVHJlZTxSb3V0ZVNlZ21lbnQ+IHsgcmV0dXJuIHRoaXMuX3ByZXZUcmVlOyB9XG59XG5cblxuY2xhc3MgX0xvYWRTZWdtZW50cyB7XG4gIHByaXZhdGUgZGVhY3RpdmF0aW9uczogT2JqZWN0W11bXSA9IFtdO1xuICBwcml2YXRlIHBlcmZvcm1NdXRhdGlvbjogYm9vbGVhbiA9IHRydWU7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBjdXJyVHJlZTogVHJlZTxSb3V0ZVNlZ21lbnQ+LCBwcml2YXRlIHByZXZUcmVlOiBUcmVlPFJvdXRlU2VnbWVudD4pIHt9XG5cbiAgbG9hZChwYXJlbnRPdXRsZXRNYXA6IFJvdXRlck91dGxldE1hcCwgcm9vdENvbXBvbmVudDogT2JqZWN0KTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgbGV0IHByZXZSb290ID0gaXNQcmVzZW50KHRoaXMucHJldlRyZWUpID8gcm9vdE5vZGUodGhpcy5wcmV2VHJlZSkgOiBudWxsO1xuICAgIGxldCBjdXJyUm9vdCA9IHJvb3ROb2RlKHRoaXMuY3VyclRyZWUpO1xuXG4gICAgcmV0dXJuIHRoaXMuY2FuRGVhY3RpdmF0ZShjdXJyUm9vdCwgcHJldlJvb3QsIHBhcmVudE91dGxldE1hcCwgcm9vdENvbXBvbmVudClcbiAgICAgICAgLnRoZW4ocmVzID0+IHtcbiAgICAgICAgICB0aGlzLnBlcmZvcm1NdXRhdGlvbiA9IHRydWU7XG4gICAgICAgICAgaWYgKHJlcykge1xuICAgICAgICAgICAgdGhpcy5sb2FkQ2hpbGRTZWdtZW50cyhjdXJyUm9vdCwgcHJldlJvb3QsIHBhcmVudE91dGxldE1hcCwgW3Jvb3RDb21wb25lbnRdKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHJlcztcbiAgICAgICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGNhbkRlYWN0aXZhdGUoY3VyclJvb3Q6IFRyZWVOb2RlPFJvdXRlU2VnbWVudD4sIHByZXZSb290OiBUcmVlTm9kZTxSb3V0ZVNlZ21lbnQ+LFxuICAgICAgICAgICAgICAgICAgICAgICAgb3V0bGV0TWFwOiBSb3V0ZXJPdXRsZXRNYXAsIHJvb3RDb21wb25lbnQ6IE9iamVjdCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRoaXMucGVyZm9ybU11dGF0aW9uID0gZmFsc2U7XG4gICAgdGhpcy5sb2FkQ2hpbGRTZWdtZW50cyhjdXJyUm9vdCwgcHJldlJvb3QsIG91dGxldE1hcCwgW3Jvb3RDb21wb25lbnRdKTtcblxuICAgIGxldCBhbGxQYXRocyA9IFByb21pc2VXcmFwcGVyLmFsbCh0aGlzLmRlYWN0aXZhdGlvbnMubWFwKHIgPT4gdGhpcy5jaGVja0NhbkRlYWN0aXZhdGVQYXRoKHIpKSk7XG4gICAgcmV0dXJuIGFsbFBhdGhzLnRoZW4oKHZhbHVlczogYm9vbGVhbltdKSA9PiB2YWx1ZXMuZmlsdGVyKHYgPT4gdikubGVuZ3RoID09PSB2YWx1ZXMubGVuZ3RoKTtcbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tDYW5EZWFjdGl2YXRlUGF0aChwYXRoOiBPYmplY3RbXSk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGxldCBjdXJyID0gUHJvbWlzZVdyYXBwZXIucmVzb2x2ZSh0cnVlKTtcbiAgICBmb3IgKGxldCBwIG9mIExpc3RXcmFwcGVyLnJldmVyc2VkKHBhdGgpKSB7XG4gICAgICBjdXJyID0gY3Vyci50aGVuKF8gPT4ge1xuICAgICAgICBpZiAoaGFzTGlmZWN5Y2xlSG9vayhcInJvdXRlckNhbkRlYWN0aXZhdGVcIiwgcCkpIHtcbiAgICAgICAgICByZXR1cm4gKDxDYW5EZWFjdGl2YXRlPnApLnJvdXRlckNhbkRlYWN0aXZhdGUodGhpcy5wcmV2VHJlZSwgdGhpcy5jdXJyVHJlZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIF87XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gY3VycjtcbiAgfVxuXG4gIHByaXZhdGUgbG9hZENoaWxkU2VnbWVudHMoY3Vyck5vZGU6IFRyZWVOb2RlPFJvdXRlU2VnbWVudD4sIHByZXZOb2RlOiBUcmVlTm9kZTxSb3V0ZVNlZ21lbnQ+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dGxldE1hcDogUm91dGVyT3V0bGV0TWFwLCBjb21wb25lbnRzOiBPYmplY3RbXSk6IHZvaWQge1xuICAgIGxldCBwcmV2Q2hpbGRyZW4gPSBpc1ByZXNlbnQocHJldk5vZGUpID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZOb2RlLmNoaWxkcmVuLnJlZHVjZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAobSwgYykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbVtjLnZhbHVlLm91dGxldF0gPSBjO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7fSkgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAge307XG5cbiAgICBjdXJyTm9kZS5jaGlsZHJlbi5mb3JFYWNoKGMgPT4ge1xuICAgICAgdGhpcy5sb2FkU2VnbWVudHMoYywgcHJldkNoaWxkcmVuW2MudmFsdWUub3V0bGV0XSwgb3V0bGV0TWFwLCBjb21wb25lbnRzKTtcbiAgICAgIFN0cmluZ01hcFdyYXBwZXIuZGVsZXRlKHByZXZDaGlsZHJlbiwgYy52YWx1ZS5vdXRsZXQpO1xuICAgIH0pO1xuXG4gICAgU3RyaW5nTWFwV3JhcHBlci5mb3JFYWNoKHByZXZDaGlsZHJlbixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHYsIGspID0+IHRoaXMudW5sb2FkT3V0bGV0KG91dGxldE1hcC5fb3V0bGV0c1trXSwgY29tcG9uZW50cykpO1xuICB9XG5cbiAgbG9hZFNlZ21lbnRzKGN1cnJOb2RlOiBUcmVlTm9kZTxSb3V0ZVNlZ21lbnQ+LCBwcmV2Tm9kZTogVHJlZU5vZGU8Um91dGVTZWdtZW50PixcbiAgICAgICAgICAgICAgIHBhcmVudE91dGxldE1hcDogUm91dGVyT3V0bGV0TWFwLCBjb21wb25lbnRzOiBPYmplY3RbXSk6IHZvaWQge1xuICAgIGxldCBjdXJyID0gY3Vyck5vZGUudmFsdWU7XG4gICAgbGV0IHByZXYgPSBpc1ByZXNlbnQocHJldk5vZGUpID8gcHJldk5vZGUudmFsdWUgOiBudWxsO1xuICAgIGxldCBvdXRsZXQgPSB0aGlzLmdldE91dGxldChwYXJlbnRPdXRsZXRNYXAsIGN1cnJOb2RlLnZhbHVlKTtcblxuICAgIGlmIChlcXVhbFNlZ21lbnRzKGN1cnIsIHByZXYpKSB7XG4gICAgICB0aGlzLmxvYWRDaGlsZFNlZ21lbnRzKGN1cnJOb2RlLCBwcmV2Tm9kZSwgb3V0bGV0Lm91dGxldE1hcCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50cy5jb25jYXQoW291dGxldC5sb2FkZWRDb21wb25lbnRdKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudW5sb2FkT3V0bGV0KG91dGxldCwgY29tcG9uZW50cyk7XG4gICAgICBpZiAodGhpcy5wZXJmb3JtTXV0YXRpb24pIHtcbiAgICAgICAgbGV0IG91dGxldE1hcCA9IG5ldyBSb3V0ZXJPdXRsZXRNYXAoKTtcbiAgICAgICAgbGV0IGxvYWRlZENvbXBvbmVudCA9IHRoaXMubG9hZE5ld1NlZ21lbnQob3V0bGV0TWFwLCBjdXJyLCBwcmV2LCBvdXRsZXQpO1xuICAgICAgICB0aGlzLmxvYWRDaGlsZFNlZ21lbnRzKGN1cnJOb2RlLCBwcmV2Tm9kZSwgb3V0bGV0TWFwLCBjb21wb25lbnRzLmNvbmNhdChbbG9hZGVkQ29tcG9uZW50XSkpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbG9hZE5ld1NlZ21lbnQob3V0bGV0TWFwOiBSb3V0ZXJPdXRsZXRNYXAsIGN1cnI6IFJvdXRlU2VnbWVudCwgcHJldjogUm91dGVTZWdtZW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgIG91dGxldDogUm91dGVyT3V0bGV0KTogT2JqZWN0IHtcbiAgICBsZXQgcmVzb2x2ZWQgPSBSZWZsZWN0aXZlSW5qZWN0b3IucmVzb2x2ZShcbiAgICAgICAgW3Byb3ZpZGUoUm91dGVyT3V0bGV0TWFwLCB7dXNlVmFsdWU6IG91dGxldE1hcH0pLCBwcm92aWRlKFJvdXRlU2VnbWVudCwge3VzZVZhbHVlOiBjdXJyfSldKTtcbiAgICBsZXQgcmVmID0gb3V0bGV0LmxvYWQocm91dGVTZWdtZW50Q29tcG9uZW50RmFjdG9yeShjdXJyKSwgcmVzb2x2ZWQsIG91dGxldE1hcCk7XG4gICAgaWYgKGhhc0xpZmVjeWNsZUhvb2soXCJyb3V0ZXJPbkFjdGl2YXRlXCIsIHJlZi5pbnN0YW5jZSkpIHtcbiAgICAgIHJlZi5pbnN0YW5jZS5yb3V0ZXJPbkFjdGl2YXRlKGN1cnIsIHByZXYsIHRoaXMuY3VyclRyZWUsIHRoaXMucHJldlRyZWUpO1xuICAgIH1cbiAgICByZXR1cm4gcmVmLmluc3RhbmNlO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRPdXRsZXQob3V0bGV0TWFwOiBSb3V0ZXJPdXRsZXRNYXAsIHNlZ21lbnQ6IFJvdXRlU2VnbWVudCk6IFJvdXRlck91dGxldCB7XG4gICAgbGV0IG91dGxldCA9IG91dGxldE1hcC5fb3V0bGV0c1tzZWdtZW50Lm91dGxldF07XG4gICAgaWYgKGlzQmxhbmsob3V0bGV0KSkge1xuICAgICAgaWYgKHNlZ21lbnQub3V0bGV0ID09IERFRkFVTFRfT1VUTEVUX05BTUUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhc2VFeGNlcHRpb24oYENhbm5vdCBmaW5kIGRlZmF1bHQgb3V0bGV0YCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgQmFzZUV4Y2VwdGlvbihgQ2Fubm90IGZpbmQgdGhlIG91dGxldCAke3NlZ21lbnQub3V0bGV0fWApO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gb3V0bGV0O1xuICB9XG5cbiAgcHJpdmF0ZSB1bmxvYWRPdXRsZXQob3V0bGV0OiBSb3V0ZXJPdXRsZXQsIGNvbXBvbmVudHM6IE9iamVjdFtdKTogdm9pZCB7XG4gICAgaWYgKGlzUHJlc2VudChvdXRsZXQpICYmIG91dGxldC5pc0xvYWRlZCkge1xuICAgICAgU3RyaW5nTWFwV3JhcHBlci5mb3JFYWNoKG91dGxldC5vdXRsZXRNYXAuX291dGxldHMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKHYsIGspID0+IHRoaXMudW5sb2FkT3V0bGV0KHYsIGNvbXBvbmVudHMpKTtcbiAgICAgIGlmICh0aGlzLnBlcmZvcm1NdXRhdGlvbikge1xuICAgICAgICBvdXRsZXQudW5sb2FkKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmRlYWN0aXZhdGlvbnMucHVzaChjb21wb25lbnRzLmNvbmNhdChbb3V0bGV0LmxvYWRlZENvbXBvbmVudF0pKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn0iXX0=